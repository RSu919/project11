<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç ”ç©¶ç®¡ç†å¾Œå° - ç¡çœ ç ”ç©¶ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { background: #2c3e50; color: white; min-height: 100vh; padding: 20px; }
        .main-content { padding: 30px; }
        .project-selector { width: 100%; padding: 10px; background: #34495e; color: white; border: none; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h4>ç®¡ç†é¸å–®</h4>
            <div id="userEmail" class="small mb-3 text-info">é©—è­‰ä¸­...</div>
            <label class="small text-muted">åˆ‡æ›ç ”ç©¶è¨ˆç•«ï¼š</label>
            <select id="projectSelect" class="project-selector"></select>
            <hr>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="handleLogout()">ç™»å‡º</button>
        </div>

        <div class="col-md-10 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="displayTitle">è¼‰å…¥ä¸­...</h2>
                <button class="btn btn-success" id="exportCsv">ğŸ“¥ åŒ¯å‡ºç ”ç©¶æ•¸æ“š (CSV)</button>
            </div>

            <div class="row mb-4">
                <div class="col-md-3"><div class="card p-3"><h6>ç¸½åƒèˆ‡è€…</h6><h2 id="countTotal">-</h2></div></div>
                <div class="col-md-3"><div class="card p-3"><h6>å·²å®Œæˆ</h6><h2 id="countDone" class="text-success">-</h2></div></div>
                <div class="col-md-3"><div class="card p-3"><h6>å¹³å‡é»è®€æ¬¡æ•¸</h6><h2 id="avgTts">-</h2></div></div>
            </div>

            <div class="card p-3">
                <h5>å—è©¦è€…åˆ—è¡¨</h5>
                <table class="table">
                    <thead><tr><th>ID</th><th>è£ç½®</th><th>é»è®€æ¬¡æ•¸</th><th>ç‹€æ…‹</th><th>å¡«ç­”é€²åº¦</th></tr></thead>
                    <tbody id="respondentList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient("https://mbdatbwrralhlkhyhxlr.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1iZGF0YndycmFsaGxraHloeGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjg2OTksImV4cCI6MjA4NTc0NDY5OX0.5kv8UvBRbYfcZGLXdKI_cWtplkN3YT05XC5AUhVtsok");

    let currentQuestId = null;

    // 1. é©—è­‰ç™»å…¥ä¸¦æŠ“å–ã€Œæ­£ç¢ºæ¬„ä½: titleã€çš„å°ˆæ¡ˆ
    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return; }
        document.getElementById('userEmail').innerText = session.user.email;

        // å°é½Š Schema: ä½¿ç”¨ research_project!inner(id, title)
        const { data: perms } = await supabase
            .from('project_permission')
            .select(`project_id, research_project!inner(id, title)`)
            .eq('user_id', session.user.id);

        if (perms && perms.length > 0) {
            const select = document.getElementById('projectSelect');
            select.innerHTML = perms.map(p => `<option value="${p.research_project.id}">${p.research_project.title}</option>`).join('');
            select.onchange = (e) => loadProjectData(e.target.value);
            loadProjectData(perms[0].research_project.id);
        }
    }

    // 2. è¼‰å…¥å°æ‡‰ç ”ç©¶æ¡ˆçš„å•å·èˆ‡çµ±è¨ˆ
    async function loadProjectData(projectId) {
        // å°é½Š Schema: questionnaire.research_id
        const { data: quest } = await supabase.from('questionnaire').select('id, title').eq('research_id', projectId).single();
        if (!quest) return;
        currentQuestId = quest.id;
        document.getElementById('displayTitle').innerText = quest.title;

        // å°é½Š Schema: respondent.tts_count, abandoned
        const { data: resp } = await supabase.from('respondent').select('*, response(count)').eq('questionnaire_id', quest.id);
        
        document.getElementById('countTotal').innerText = resp.length;
        document.getElementById('countDone').innerText = resp.filter(r => !r.abandoned).length;
        const totalTts = resp.reduce((sum, r) => sum + (r.tts_count || 0), 0);
        document.getElementById('avgTts').innerText = resp.length > 0 ? (totalTts / resp.length).toFixed(1) : 0;

        document.getElementById('respondentList').innerHTML = resp.map(r => `
            <tr>
                <td><code>${r.id.substring(0,8)}</code></td>
                <td>${r.device_type}</td>
                <td>${r.tts_count || 0} æ¬¡</td>
                <td>${r.abandoned ? 'âŒ æµå¤±' : 'âœ… å®Œæˆ'}</td>
                <td>${r.response ? r.response[0].count : 0} é¡Œ</td>
            </tr>
        `).join('');
    }

    // 3. åŒ¯å‡º CSV (å°é½Š answer_value)
    document.getElementById('exportCsv').onclick = async () => {
        // æŠ“å–é¡Œç›®æ¸…å–®
        const { data: qData } = await supabase.from('question').select('id, question_text, order_index').order('order_index');
        // æŠ“å–å—è©¦è€…èˆ‡ç­”æ¡ˆ (å°é½Š answer_value)
        const { data: rData } = await supabase.from('respondent').select(`*, response(question_id, answer_value)`).eq('questionnaire_id', currentQuestId);

        let csv = "\ufeffID,è£ç½®,é»è®€ç¸½æ•¸,ç‹€æ…‹," + qData.map(q => `Q${q.order_index}`).join(",") + "\n";
        rData.forEach(r => {
            let row = [r.id, r.device_type, r.tts_count, r.abandoned ? "æµå¤±" : "å®Œæˆ"];
            qData.forEach(q => {
                const ans = r.response.find(a => a.question_id === q.id);
                row.push(ans ? `"${ans.answer_value}"` : "");
            });
            csv += row.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ç¡çœ ç ”ç©¶æ•¸æ“š_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    };

    window.handleLogout = async () => { await supabase.auth.signOut(); window.location.href = 'login.html'; };
    init();
</script>
</body>
</html>