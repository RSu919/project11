<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç ”ç©¶é¡Œç›®ç·¨è¼¯å™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 40px; }
        .editor-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .block-header { background: #4c51bf; color: white; padding: 10px 20px; border-radius: 8px; margin-top: 30px; }
        .question-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .sticky-top-save { position: sticky; top: 20px; z-index: 1000; text-align: right; margin-bottom: 20px; }
        .status-badge { font-size: 0.9rem; margin-right: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="sticky-top-save">
        <span id="statusText" class="status-badge text-muted"></span>
        <button id="btnSaveAll" class="btn btn-primary btn-lg shadow">ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´</button>
        <a href="admin.html" class="btn btn-outline-secondary btn-lg shadow">è¿”å›å¾Œå°</a>
    </div>

    <div class="editor-card">
        <h2>ğŸ“ é¡Œç›®æ•˜è¿°ç·¨è¼¯å™¨ (å¿«é€ŸåŒæ­¥ç‰ˆ)</h2>
        <p class="text-muted">ä¿®æ”¹å¾Œè«‹é»æ“Šã€Œå„²å­˜æ‰€æœ‰è®Šæ›´ã€ï¼Œç³»çµ±æœƒä¸€æ¬¡æ€§åŒæ­¥ 102 é¡Œæ•¸æ“šã€‚</p>
        <hr>
        <div id="editorContainer">
            <div class="text-center py-5">è®€å–é¡Œç›®è³‡æ–™ä¸­...</div>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    
    // åˆå§‹åŒ– Supabase
    const supabase = createClient(
        "https://mbdatbwrralhlkhyhxlr.supabase.co", 
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1iZGF0YndycmFsaGxraHloeGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjg2OTksImV4cCI6MjA4NTc0NDY5OX0.5kv8UvBRbYfcZGLXdKI_cWtplkN3YT05XC5AUhVtsok"
    );

    const QID = "db949a8e-95ad-454e-9fa4-050cf9ed238a";

    // 1. è¼‰å…¥è³‡æ–™ (å¢åŠ ä¸å¿«å–è¨­å®š)
    async function loadEditor() {
        const { data: blocks, error } = await supabase
            .from('question_block')
            .select(`id, title, question(id, question_text, order_index)`)
            .eq('questionnaire_id', QID)
            .order('order_index', { ascending: true });

        if (error) {
            console.error("è®€å–å¤±æ•—:", error.message);
            return alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        }

        const container = document.getElementById('editorContainer');
        container.innerHTML = blocks.map(block => `
            <div class="block-header">å€å¡Šï¼š${block.title}</div>
            <div class="p-3">
                ${block.question.sort((a,b) => a.order_index - b.order_index).map(q => `
                    <div class="row question-row align-items-center">
                        <div class="col-md-1 text-muted">#${q.order_index}</div>
                        <div class="col-md-11">
                            <input type="text" class="form-control q-input" 
                                   data-id="${q.id}" 
                                   value="${q.question_text}">
                        </div>
                    </div>
                `).join('')}
            </div>
        `).join('');
    }

    // 2. âš¡ å¿«é€Ÿæ‰¹é‡å„²å­˜é‚è¼¯
    document.getElementById('btnSaveAll').onclick = async () => {
        const btn = document.getElementById('btnSaveAll');
        const statusText = document.getElementById('statusText');
        const inputs = document.querySelectorAll('.q-input');
        
        // æ‰“åŒ…æ‰€æœ‰è³‡æ–™æˆä¸€å€‹é™£åˆ—
        const updates = Array.from(inputs).map(input => ({
            id: input.dataset.id,
            question_text: input.value
        }));

        btn.disabled = true;
        btn.innerText = "âš¡ æ­£åœ¨åŒæ­¥æ•¸æ“š...";
        statusText.innerText = "æ­£åœ¨å‚³é€å°åŒ…...";

        // ä½¿ç”¨ upsert é€²è¡Œå–®æ¬¡æ‰¹é‡æ›´æ–°ï¼Œè§£æ±ºæ…¢é€Ÿèˆ‡å¤±æ•—å•é¡Œ
        const { data, error } = await supabase
            .from('question')
            .upsert(updates, { onConflict: 'id' })
            .select(); // å¼·åˆ¶å›å‚³æ›´æ–°å¾Œçš„è³‡æ–™ä»¥ç¢ºä¿æˆåŠŸ

        if (error) {
            console.error("å„²å­˜å¤±æ•—:", error.message);
            alert("âŒ å„²å­˜å¤±æ•—ï¼åŸå› ï¼š" + error.message);
            btn.disabled = false;
            btn.innerText = "ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´";
        } else if (data) {
            statusText.className = "status-badge text-success";
            statusText.innerText = `âœ… æˆåŠŸæ›´æ–° ${data.length} é¡Œ`;
            alert(`âœ… å„²å­˜æˆåŠŸï¼${data.length} é¡Œå·²æ›´æ–°ã€‚ç¶²é å°‡è‡ªå‹•é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿æ•¸æ“šæ­£ç¢ºã€‚`);
            
            // é‡è¦ï¼šå¼·åˆ¶é‡æ–°æ•´ç†ï¼Œé¿å…å¿«å–é€ æˆã€Œå¾©åŸã€å‡è±¡
            window.location.reload(); 
        }
    };

    loadEditor();
</script>
</body>
</html>